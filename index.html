<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Poker Coach</title>
  <meta name="theme-color" content="#0b0b0b">
  <link rel="manifest" href="/manifest.webmanifest">
  <link rel="apple-touch-icon" href="/icon-192.png">
  <style>
    :root{
      --bg:#0b0b0b; --fg:#f3f3f3; --muted:#a7a7a7; --accent:#22c55e; --warn:#f59e0b; --danger:#ef4444; 
      --card:#161616; --border:#2a2a2a;
    }
    *{box-sizing:border-box;font-family:system-ui,Segoe UI,Roboto,Arial}
    body{margin:0;background:var(--bg);color:var(--fg)}
    h1{margin:16px 16px 8px;font-size:22px}
    .wrap{display:grid;gap:12px;padding:12px}
    .grid{display:grid;gap:12px}
    @media(min-width:900px){.grid{grid-template-columns:1.2fr .8fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px}
    .card h2{margin:0 0 8px;font-size:16px;color:var(--muted)}
    .card .inner{padding:12px}
    video{width:100%;height:340px;background:#000;border-radius:12px;object-fit:cover}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    button{
      appearance:none;border:1px solid var(--border);background:#1f1f1f;
      color:var(--fg);padding:12px 16px;border-radius:12px;font-weight:600;cursor:pointer;
      transition:transform .02s ease-in-out
    }
    button:active{transform:scale(.98)}
    .btn-primary{background:var(--accent);color:#06210f;border-color:#1f7a43}
    .btn-warn{background:var(--warn);color:#231a02;border-color:#8a6506}
    .btn-danger{background:var(--danger);color:#2a0707;border-color:#9b1c1c}
    .btn-ghost{background:#1b1b1b}
    .btn-lg{padding:14px 18px;font-size:16px}
    .status{font-size:13px;color:var(--muted)}
    .fields{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .fields label{font-size:12px;color:var(--muted);display:block;margin-bottom:4px}
    .fields input, .fields select{
      width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);
      background:#111;color:var(--fg)
    }
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;
      background:#121212;border:1px solid var(--border);font-size:12px;color:var(--muted)}
    .ok{color:#10b981}.maybe{color:#f59e0b}.bad{color:#ef4444}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
    .scanlog{white-space:pre-wrap;background:#0f0f0f;border:1px dashed #333;border-radius:10px;padding:10px;font-size:12px;color:#c9c9c9}
  </style>
</head>
<body>
  <h1>Poker Coach</h1>

  <div class="wrap grid">
    <!-- CAMERA + CONTROLS -->
    <section class="card">
      <div class="inner">
        <h2>Scanner</h2>
        <video id="camera" playsinline muted></video>
        <div class="row" style="margin-top:10px">
          <button id="btnStart" class="btn-lg btn-primary">Camera aan</button>
          <button id="btnStop" class="btn-lg btn-danger">Camera uit</button>
          <button id="btnCalibrate" class="btn-lg btn-ghost">Kalibreer</button>
          <button id="btnScan" class="btn-lg btn-warn">Scannen</button>
          <button id="btnAdvice" class="btn-lg btn-ghost">Toon advies</button>
          <span id="status" class="status"></span>
        </div>
        <div class="row" style="margin-top:8px">
          <span class="pill">Kalibratie: <strong id="calibState" class="ok">OK</strong></span>
          <span class="pill">Herkenning: <strong id="recConf" class="maybe">–</strong></span>
          <span class="pill">FPS: <strong id="fps" class="">–</strong></span>
        </div>
      </div>
    </section>

    <!-- FIELDS + RESULT -->
    <section class="card">
      <div class="inner">
        <h2>Gevulde velden</h2>
        <div class="fields">
          <div>
            <label for="hand">Jouw hand</label>
            <input id="hand" placeholder="Bijv. AhKh" autocomplete="off">
          </div>
          <div>
            <label for="positie">Positie</label>
            <select id="positie">
              <option value="">–</option>
              <option>UTG</option><option>UTG+1</option><option>MP</option>
              <option>CO</option><option>BTN</option><option>SB</option><option>BB</option>
            </select>
          </div>
          <div>
            <label for="players"># Spelers aan tafel</label>
            <input id="players" type="number" min="2" max="10" placeholder="6">
          </div>
          <div>
            <label for="callers"># Callers</label>
            <input id="callers" type="number" min="0" max="9" placeholder="0">
          </div>
          <div>
            <label for="raisers"># Raisers</label>
            <input id="raisers" type="number" min="0" max="3" placeholder="0">
          </div>
          <div>
            <label for="pot">Pot (preflop)</label>
            <input id="pot" type="number" step="0.01" placeholder="0.00">
          </div>
          <div>
            <label for="stack">Jouw stack</label>
            <input id="stack" type="number" step="1" placeholder="100">
          </div>
          <div>
            <label for="blinds">Blinds</label>
            <input id="blinds" placeholder="1/2, 0.5/1, etc.">
          </div>
        </div>

        <div style="margin-top:10px">
          <label>Laatste scan (debug):</label>
          <div id="scanLog" class="scanlog mono">Nog geen scan uitgevoerd.</div>
        </div>
      </div>
    </section>
  </div>

  <script>
  // ======= Camera & Scanner Integratie =======
  (function(){
    const els = {
      video: document.getElementById('camera'),
      btnStart: document.getElementById('btnStart'),
      btnStop: document.getElementById('btnStop'),
      btnCalibrate: document.getElementById('btnCalibrate'),
      btnScan: document.getElementById('btnScan'),
      btnAdvice: document.getElementById('btnAdvice'),
      status: document.getElementById('status'),
      calibState: document.getElementById('calibState'),
      recConf: document.getElementById('recConf'),
      fps: document.getElementById('fps'),
      // fields:
      hand: document.getElementById('hand'),
      positie: document.getElementById('positie'),
      players: document.getElementById('players'),
      callers: document.getElementById('callers'),
      raisers: document.getElementById('raisers'),
      pot: document.getElementById('pot'),
      stack: document.getElementById('stack'),
      blinds: document.getElementById('blinds'),
      scanLog: document.getElementById('scanLog'),
    };

    let stream = null;
    let rafId = null;
    let lastFpsTime = 0, frames = 0;

    // --- Camera controls ---
    async function startCamera(){
      try{
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false });
        els.video.srcObject = stream;
        await els.video.play();
        tickFps();
        setStatus('Camera actief.');
      }catch(err){
        setStatus('Camera fout: ' + err.message);
      }
    }
    function stopCamera(){
      cancelAnimationFrame(rafId);
      if(stream){
        stream.getTracks().forEach(t=>t.stop());
        stream = null;
      }
      els.video.srcObject = null;
      els.fps.textContent = '–';
      setStatus('Camera uit.');
    }
    function tickFps(time){
      frames++;
      if(!lastFpsTime) lastFpsTime = time || performance.now();
      const now = time || performance.now();
      if(now - lastFpsTime > 1000){
        els.fps.textContent = frames.toString();
        frames = 0;
        lastFpsTime = now;
      }
      rafId = requestAnimationFrame(tickFps);
    }
    function setStatus(msg){ els.status.textContent = msg; }

    // --- Kalibratie (dummy + hook) ---
    async function calibrate(){
      // Hier kun je bv. een referentiekader vastleggen (tafelranden, HUD-positie, crop-regio's)
      await ScannerService.calibrate(els.video);
      els.calibState.textContent = 'OK';
      els.calibState.className = 'ok';
      setStatus('Kalibratie voltooid.');
    }

    // --- Scannen -> velden vullen ---
    async function scan(){
      setStatus('Scannen…');
      const data = await ScannerService.scan(els.video);
      // verwacht data als:
      // {
      //   hand: "AhKh", positie: "UTG", players: 6,
      //   callers: 0, raisers: 1, pot: 3.5, stack: 120, blinds: "1/2",
      //   confidence: 0.86, raw: { ... }
      // }
      fillFieldsFromScan(data);
      logScan(data);
      updateConfidence(data.confidence);
      setStatus('Scan gereed.');
    }

    function updateConfidence(c){
      if(typeof c !== 'number'){ els.recConf.textContent = '–'; els.recConf.className='maybe'; return; }
      const pct = Math.round(c*100);
      els.recConf.textContent = pct + '%';
      els.recConf.className = pct >= 85 ? 'ok' : (pct >= 60 ? 'maybe' : 'bad');
    }

    function fillFieldsFromScan(d){
      // Alleen invullen wanneer er een waarde is, zodat handmatige correctie behouden blijft
      if(d.hand) els.hand.value = d.hand;
      if(d.positie) els.positiesel ? els.positiesel.value = d.positie : els.positie.value = d.positie;
      if(Number.isFinite(d.players)) els.players.value = d.players;
      if(Number.isFinite(d.callers)) els.callers.value = d.callers;
      if(Number.isFinite(d.raisers)) els.raisers.value = d.raisers;
      if(Number.isFinite(d.pot)) els.pot.value = d.pot;
      if(Number.isFinite(d.stack)) els.stack.value = d.stack;
      if(d.blinds) els.blinds.value = d.blinds;
    }

    function logScan(d){
      els.scanLog.textContent = JSON.stringify(d, null, 2);
    }

    // --- Advies (hook; gebruikt ingevulde velden) ---
    function showAdvice(){
      const input = {
        hand: els.hand.value.trim(),
        positie: els.positie.value,
        players: +els.players.value || null,
        callers: +els.callers.value || 0,
        raisers: +els.raisers.value || 0,
        pot: +els.pot.value || 0,
        stack: +els.stack.value || 0,
        blinds: els.blinds.value.trim()
      };
      // Hier koppel je jouw GTO/regels aan de ingevulde waarden:
      const advies = SimpleAdvisor.advise(input);
      alert(`Advies: ${advies.action}\n\nUitleg: ${advies.reason}`);
    }

    // --- Events ---
    els.btnStart.addEventListener('click', startCamera);
    els.btnStop.addEventListener('click', stopCamera);
    els.btnCalibrate.addEventListener('click', calibrate);
    els.btnScan.addEventListener('click', scan);
    els.btnAdvice.addEventListener('click', showAdvice);

    // ======= ScannerService =======
    // Vervang de inhoud van scan() door jouw echte herkenning (Tesseract, TensorFlow, OpenCV.js, HUD parsing).
    const ScannerService = {
      calibrated: false,
      async calibrate(videoEl){
        // Voorbeeld: bereken crop-regio's aan de hand van resolutie
        this.calibrated = true;
        return true;
      },
      async scan(videoEl){
        if(!this.calibrated){
          // auto-kalibreer als user dat vergat
          await this.calibrate(videoEl);
        }

        // -----
        // Plaats hier jouw echte herkenning:
        // - Lees frame van videoEl naar canvas
        // - OCR: Tesseract.js (blinds, stacks, HUD tekst)
        // - Card detection: template matching / ML / kleur-masks
        // - Positie: HUD highlight of seat index
        // - #players: getelde avatars/stoelen actief
        // -----

        // Dummy voorbeeldresultaat (zodat de flow al werkt)
        const dummy = this._mockDetect();
        return dummy;
      },
      _mockDetect(){
        // Simuleer realistische variatie, om de UI te testen
        const pos = ['UTG','UTG+1','MP','CO','BTN','SB','BB'][Math.floor(Math.random()*7)];
        const hands = ['AhKh','QsQd','9c9s','AdJs','7h8h','KcQc'];
        const val = hands[Math.floor(Math.random()*hands.length)];
        const players = [6,7,8,9][Math.floor(Math.random()*4)];
        const callers = Math.floor(Math.random()*3);
        const raisers = Math.floor(Math.random()*2);
        const pot = +(Math.random()*6+1).toFixed(2);
        const stack = Math.floor(Math.random()*150)+50;
        const blinds = Math.random()>0.5 ? '1/2' : '0.5/1';
        const confidence = +(0.6 + Math.random()*0.35).toFixed(2);
        return {
          hand: val, positie: pos, players, callers, raisers, pot, stack, blinds,
          confidence,
          raw: { note: 'mock-resultaat ter illustratie' }
        };
      }
    };

    // ======= SimpleAdvisor (placeholder) =======
    const SimpleAdvisor = {
      advise(input){
        // Supersimpel voorbeeld (vervang dit door jouw GTO/regels)
        // Voorbeeldregel: 100bb deep, BTN en geen raise => open-raise.
        const deep = input.stack && input.blinds && parseFloat(input.blinds.split('/')[1]||input.blinds) ? 
          input.stack / parseFloat(input.blinds.split('/')[1]||input.blinds) : null;

        if(input.positie==='BTN' && input.raisers===0){
          return { action: 'Open-raise 2.5bb', reason: 'Button, geen raise voor je, brede opening toegestaan.' };
        }
        if(input.raisers>=1 && /A[KQJ]|QQ|JJ|TT/.test(input.hand)){
          return { action: '3-bet', reason: 'Sterke hand tegen eerdere raise.' };
        }
        if(input.raisers>=1 && !/A[KQJ]|QQ|JJ|TT/.test(input.hand)){
          return { action: 'Fold', reason: 'Eerdere agressie en hand buiten 3-bet range.' };
        }
        if(deep && deep < 30 && input.hand.match(/[KQJT]s/)){
          return { action: 'Shove of 3-bet jam', reason: 'Short stack met speelbare suited broadway.' };
        }
        return { action: 'Check/Fold', reason: 'Conservatief default advies; verfijn met echte ranges.' };
      }
    };

    // Optioneel: start camera meteen (comment uit als je dit niet wilt)
    // startCamera();
  })();
  </script>
</body>
</html>
